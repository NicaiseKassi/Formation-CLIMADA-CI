<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Connexion - Manuel CLIMADA</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .login-container {
        background: white;
        padding: 50px 40px;
        border-radius: 15px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
        max-width: 500px;
        width: 100%;
        text-align: center;
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
        font-size: 26px;
      }

      h2 {
        color: #667eea;
        margin-bottom: 15px;
        font-size: 15px;
        font-weight: normal;
      }

      .info-box {
        background: #f0f4ff;
        border-left: 4px solid #667eea;
        padding: 20px;
        margin: 25px 0;
        border-radius: 8px;
        text-align: left;
      }

      .info-box p {
        margin: 8px 0;
        color: #555;
        line-height: 1.6;
      }

      .info-box strong {
        color: #667eea;
      }

      form {
        text-align: left;
        margin-top: 15px;
      }

      label {
        display: block;
        margin-bottom: 6px;
        color: #555;
        font-weight: 600;
      }

      input[type="email"],
      input[type="password"] {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 15px;
        margin-bottom: 14px;
        transition: border 0.3s;
      }

      input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
      }

      .btn {
        width: 100%;
        padding: 14px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s, transform 0.2s;
      }

      .btn:hover:not(:disabled) {
        background: #5568d3;
        transform: translateY(-1px);
      }

      .btn:disabled {
        background: #cbd5f5;
        cursor: not-allowed;
      }

      .panel {
        display: none;
      }

      .panel.active {
        display: block;
      }

      #status {
        margin: 20px 0;
        padding: 15px;
        border-radius: 8px;
        display: none;
        white-space: pre-line;
        text-align: left;
        line-height: 1.6;
      }

      #status.show {
        display: block;
      }

      #status.info {
        background: #e3f2fd;
        color: #1565c0;
        border: 1px solid #90caf9;
      }

      #status.success {
        background: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #81c784;
      }

      #status.error {
        background: #ffebee;
        color: #c62828;
        border: 1px solid #ef9a9a;
      }

      .contact {
        margin-top: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        font-size: 13px;
        text-align: left;
      }

      .contact h3 {
        color: #667eea;
        margin-bottom: 10px;
        font-size: 14px;
      }

      .contact p {
        margin: 5px 0;
        color: #666;
      }

      .contact a {
        color: #667eea;
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <div class="login-container">
      <h1>üéì Manuel de Formation CLIMADA</h1>
      <h2>Direction G√©n√©rale de l'√âconomie - C√¥te d'Ivoire</h2>

      <div id="status"></div>

      <div class="info-box" id="instructions-box">
        <p><strong>üìß Premi√®re connexion ?</strong></p>
        <p>
          <strong style="color: #c62828">‚ö†Ô∏è IMPORTANT :</strong> Lorsque vous
          recevez l'email d'invitation :
        </p>
        <ol style="margin: 10px 0 10px 20px; line-height: 1.8">
          <li>Cliquez sur le lien re√ßu par email</li>
          <li>D√©finissez votre mot de passe (formulaire ci-dessous)</li>
          <li>Revenez ensuite sur cette page pour vous connecter</li>
        </ol>
      </div>

      <div id="login-panel" class="panel active">
        <h3 style="margin-bottom: 10px; color: #444">üîê Connexion au manuel</h3>
        <form id="login-form">
          <label for="login-email">Email</label>
          <input type="email" id="login-email" autocomplete="email" required />

          <label for="login-password">Mot de passe</label>
          <input
            type="password"
            id="login-password"
            autocomplete="current-password"
            required
          />

          <button type="submit" class="btn" id="login-btn">Se connecter</button>
        </form>
      </div>

      <div id="invite-panel" class="panel">
        <h3 style="margin-bottom: 10px; color: #444">
          üéâ Activation de votre compte
        </h3>
        <p style="text-align: left; color: #555">
          Vous avez √©t√© invit√© au manuel CLIMADA. Choisissez votre mot de passe
          pour activer votre acc√®s.
        </p>
        <form id="invite-form">
          <label for="invite-password">Nouveau mot de passe</label>
          <input type="password" id="invite-password" required minlength="6" />

          <label for="invite-password-confirm">Confirmer le mot de passe</label>
          <input
            type="password"
            id="invite-password-confirm"
            required
            minlength="6"
          />

          <button type="submit" class="btn" id="invite-btn">
            Valider et acc√©der au manuel
          </button>
        </form>
      </div>

      <div class="contact">
        <h3>üìû Support</h3>
        <p>
          <strong>Nicaise KASSI</strong> -
          <a href="mailto:ettekassi@gmail.com">ettekassi@gmail.com</a> -
          0709252846
        </p>
        <p>
          <strong>Luc COULIBALY</strong> -
          <a href="mailto:riflardluc_coulibaly@yahoo.fr"
            >riflardluc_coulibaly@yahoo.fr</a
          >
          - 0707342607
        </p>
      </div>
    </div>

    <script>
      (function () {
        const SESSION_KEY = "climada_manual_session";
        const API_URL =
          "https://formation-climada-dge.netlify.app/.netlify/identity";

        const statusEl = document.getElementById("status");
        const loginPanel = document.getElementById("login-panel");
        const invitePanel = document.getElementById("invite-panel");
        const instructionsBox = document.getElementById("instructions-box");
        const loginForm = document.getElementById("login-form");
        const inviteForm = document.getElementById("invite-form");
        const loginBtn = document.getElementById("login-btn");
        const inviteBtn = document.getElementById("invite-btn");

        let auth = null;
        let inviteToken = null;

        function showStatus(message, type) {
          statusEl.textContent = message;
          statusEl.className = `show ${type}`;
        }

        function hideStatus() {
          statusEl.className = "";
          statusEl.textContent = "";
        }

        function showPanel(panel) {
          loginPanel.classList.remove("active");
          invitePanel.classList.remove("active");
          panel.classList.add("active");
        }

        function redirectToManual(delay = 800) {
          setTimeout(() => {
            window.location.href = "/chapitre1_installation/";
          }, delay);
        }

        function ensureAuthInstance() {
          if (!auth) {
            return null;
          }
          return auth;
        }

        function handleLogin(event) {
          event.preventDefault();
          hideStatus();

          if (!ensureAuthInstance()) {
            showStatus(
              "‚è≥ Chargement de l'authentification... Veuillez patienter et r√©essayer.",
              "info"
            );
            return;
          }

          const email = document.getElementById("login-email").value.trim();
          const password = document
            .getElementById("login-password")
            .value.trim();

          if (!email || !password) {
            showStatus("‚ùå Email et mot de passe requis", "error");
            return;
          }

          loginBtn.disabled = true;
          loginBtn.textContent = "Connexion...";

          auth
            .login(email, password, true)
            .then((user) => {
              console.log("‚úÖ Connexion r√©ussie", user.email);
              localStorage.setItem(SESSION_KEY, Date.now().toString());
              showStatus(
                "‚úÖ Connexion r√©ussie ! Acc√®s au manuel...",
                "success"
              );
              redirectToManual();
            })
            .catch((error) => {
              console.error("Erreur login", error);
              let message = "‚ùå Impossible de se connecter.";

              if (error && error.msg) {
                message += `\n\n${error.msg}`;
              } else if (error && error.code === 401) {
                message =
                  "‚ùå Email ou mot de passe incorrect. V√©rifiez vos identifiants ou r√©initialisez votre mot de passe.";
              } else if (error && error.message) {
                if (error.message.includes("confirm")) {
                  message =
                    "‚ùå Votre email n'est pas encore confirm√©.\n\nCliquez sur le lien re√ßu par email, puis r√©essayez.";
                } else if (
                  error.message.includes("password") ||
                  error.message.includes("credentials")
                ) {
                  message =
                    "‚ùå Email ou mot de passe incorrect. V√©rifiez votre mot de passe ou r√©initialisez-le.";
                } else {
                  message += `\n\n${error.message}`;
                }
              }

              showStatus(message, "error");
              loginBtn.disabled = false;
              loginBtn.textContent = "Se connecter";
            });
        }

        function handleInvite(event) {
          event.preventDefault();
          hideStatus();

          if (!ensureAuthInstance()) {
            showStatus(
              "‚è≥ Chargement de l'authentification... Veuillez patienter et r√©essayer.",
              "info"
            );
            return;
          }

          if (!inviteToken) {
            showStatus("‚ùå Jeton d'invitation manquant.", "error");
            return;
          }

          const password = document
            .getElementById("invite-password")
            .value.trim();
          const confirmPassword = document
            .getElementById("invite-password-confirm")
            .value.trim();

          if (password.length < 6) {
            showStatus(
              "‚ùå Mot de passe trop court. Minimum 6 caract√®res.",
              "error"
            );
            return;
          }

          if (password !== confirmPassword) {
            showStatus("‚ùå Les mots de passe ne correspondent pas.", "error");
            return;
          }

          inviteBtn.disabled = true;
          inviteBtn.textContent = "Activation en cours...";

          auth
            .acceptInvite(inviteToken, password, true)
            .then((user) => {
              console.log("‚úÖ Invitation accept√©e", user.email);
              localStorage.setItem(SESSION_KEY, Date.now().toString());
              showStatus(
                "‚úÖ Mot de passe d√©fini ! Acc√®s au manuel en cours...",
                "success"
              );
              clearHash();
              redirectToManual(1200);
            })
            .catch((error) => {
              console.error("Erreur acceptInvite", error);
              let message =
                "‚ùå Impossible d'activer votre compte. Le lien est peut-√™tre expir√©.";
              if (error && error.msg) {
                message += `\n\n${error.msg}`;
              }
              showStatus(message, "error");
              inviteBtn.disabled = false;
              inviteBtn.textContent = "Valider et acc√©der au manuel";
            });
        }

        function clearHash() {
          if (window.history && window.history.replaceState) {
            window.history.replaceState(null, "", window.location.pathname);
          }
        }

        function processHash() {
          const hash = window.location.hash.replace(/^#/, "");
          if (!hash) {
            return;
          }

          const params = new URLSearchParams(hash);

          if (params.has("invite_token")) {
            inviteToken = params.get("invite_token");
            showStatus(
              "üéâ Invitation d√©tect√©e ! Choisissez un mot de passe pour activer votre compte.",
              "info"
            );
            showPanel(invitePanel);
            instructionsBox.style.display = "none";
            return;
          }

          if (params.has("confirmation_token")) {
            const token = params.get("confirmation_token");
            showStatus("üìß Confirmation de votre email...", "info");

            auth
              .confirm(token)
              .then((user) => {
                console.log("‚úÖ Email confirm√©", user?.email);
                if (user) {
                  localStorage.setItem(SESSION_KEY, Date.now().toString());
                  showStatus(
                    "‚úÖ Email confirm√© ! Ouverture du manuel...",
                    "success"
                  );
                  clearHash();
                  redirectToManual();
                } else {
                  showStatus(
                    "‚úÖ Email confirm√©. Vous pouvez maintenant vous connecter.",
                    "success"
                  );
                  clearHash();
                }
              })
              .catch((error) => {
                console.error("Erreur confirmation", error);
                showStatus(
                  "‚ùå Le lien de confirmation n'est plus valide. Demandez un nouvel email.",
                  "error"
                );
              });

            return;
          }

          if (params.has("recovery_token")) {
            showStatus(
              "üîë Lien de r√©cup√©ration d√©tect√©. R√©initialisez votre mot de passe.",
              "info"
            );
            return;
          }
        }

        function checkExistingSession() {
          try {
            const currentUser = auth.currentUser();
            if (currentUser) {
              console.log("‚úÖ Session existante", currentUser.email);
              localStorage.setItem(SESSION_KEY, Date.now().toString());
              showStatus(
                "‚úÖ Vous √™tes d√©j√† connect√©. Acc√®s au manuel...",
                "success"
              );
              redirectToManual();
            }
          } catch (error) {
            console.error("Impossible de v√©rifier la session", error);
          }
        }

        function monitorSession() {
          try {
            const currentUser = auth.currentUser();
            if (currentUser) {
              console.log(
                "‚úÖ Connexion d√©tect√©e automatiquement",
                currentUser.email
              );
              localStorage.setItem(SESSION_KEY, Date.now().toString());
              showStatus(
                "‚úÖ Authentification valid√©e ! Ouverture du manuel...",
                "success"
              );
              redirectToManual();
            }
          } catch (error) {
            console.error("Erreur surveillance session", error);
          }
        }

        function waitForGoTrue(attempt = 0) {
          if (window.GoTrue) {
            auth = new window.GoTrue({
              APIUrl: API_URL,
              setCookie: true,
            });
            console.log("GoTrue initialis√©");
            processHash();
            checkExistingSession();
            setInterval(monitorSession, 2000);
          } else if (attempt < 20) {
            setTimeout(() => waitForGoTrue(attempt + 1), 250);
          } else {
            showStatus(
              "‚ö†Ô∏è Impossible de charger l'authentification. Rafra√Æchissez la page ou contactez le support.",
              "error"
            );
          }
        }

        loginForm.addEventListener("submit", handleLogin);
        inviteForm.addEventListener("submit", handleInvite);

        waitForGoTrue();
      })();
    </script>
  </body>
</html>
