<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manuel de Formation CLIMADA - Authentification</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
      body {
        font-family: "Arial", sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .auth-container {
        background: white;
        padding: 50px;
        border-radius: 15px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        text-align: center;
        max-width: 500px;
        width: 90%;
      }
      h1 {
        color: #333;
        margin-bottom: 10px;
        font-size: 28px;
      }
      h2 {
        color: #667eea;
        margin-bottom: 20px;
        font-size: 20px;
        font-weight: normal;
      }
      .loading {
        margin: 40px 0;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .message {
        color: #666;
        margin-top: 20px;
        font-size: 16px;
      }
      .success {
        color: #28a745;
      }
      .warning {
        color: #ffc107;
      }
      .error {
        color: #dc3545;
      }
      .contact {
        margin-top: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
      }
      .contact h3 {
        color: #667eea;
        margin-bottom: 15px;
        font-size: 16px;
      }
      .contact p {
        margin: 8px 0;
        color: #666;
        font-size: 14px;
      }
      .contact a {
        color: #667eea;
        text-decoration: none;
      }
      .contact a:hover {
        text-decoration: underline;
      }
      .btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 30px;
        font-size: 16px;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 20px;
      }
      .btn:hover {
        background: #5568d3;
      }
      .footer {
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid #eee;
        color: #999;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="auth-container">
      <h1>üéì Manuel de Formation CLIMADA</h1>
      <h2>Direction G√©n√©rale de l'√âconomie - C√¥te d'Ivoire</h2>

      <div id="auth-status">
        <div class="loading">
          <div class="spinner"></div>
          <p class="message">üîê Initialisation de l'authentification...</p>
        </div>
      </div>

      <div class="contact">
        <h3>üìû Support Technique</h3>
        <p><strong>Nicaise KASSI</strong></p>
        <p>üìß <a href="mailto:ettekassi@gmail.com">ettekassi@gmail.com</a></p>
        <p>üì± <a href="tel:0709252846">0709252846</a></p>
        <hr style="margin: 15px 0; border: 0; border-top: 1px solid #ddd" />
        <p><strong>Luc COULIBALY</strong></p>
        <p>
          üìß
          <a href="mailto:riflardluc_coulibaly@yahoo.fr"
            >riflardluc_coulibaly@yahoo.fr</a
          >
        </p>
        <p>üì± <a href="tel:0707342607">0707342607</a></p>
      </div>

      <div class="footer">
        <p>¬© 2025 DGE - Minist√®re de l'√âconomie et des Finances</p>
      </div>
    </div>

    <script>
      const authStatus = document.getElementById("auth-status");
      const SESSION_KEY = "climada_manual_session";

      console.log("=== PAGE D'AUTHENTIFICATION ===");

      if (window.netlifyIdentity) {
        
        // Afficher le modal de connexion
        function showLoginModal() {
          authStatus.innerHTML = `
            <p class="message">üîí Acc√®s r√©serv√© aux participants de la formation</p>
            <p class="message">Veuillez vous connecter avec vos identifiants</p>
          `;
          setTimeout(() => {
            netlifyIdentity.open();
          }, 500);
        }

        // Au chargement, v√©rifier l'utilisateur
        netlifyIdentity.on("init", (user) => {
          console.log("Init - User:", user ? user.email : "none");
          
          // Nettoyer le hash de l'URL
          if (window.location.hash) {
            window.history.replaceState(null, null, window.location.pathname);
          }
          
          if (!user) {
            // Pas d'utilisateur - montrer le modal
            showLoginModal();
          } else {
            // Utilisateur d√©j√† connect√© - v√©rifier s'il vient de confirmer
            const fromConfirmation = document.referrer.includes('netlify') || 
                                     window.location.search.includes('confirmation');
            
            if (fromConfirmation) {
              // Vient de confirmer - demander de se reconnecter
              console.log("Confirmation d√©tect√©e - demander login");
              authStatus.innerHTML = `
                <p class="message success">‚úÖ Email confirm√© !</p>
                <p class="message">Veuillez vous connecter pour continuer</p>
              `;
              netlifyIdentity.logout();
              setTimeout(showLoginModal, 2000);
            } else {
              // D√©j√† authentifi√© - rediriger
              console.log("D√©j√† connect√© - redirection");
              authStatus.innerHTML = `
                <p class="message">‚úÖ Vous √™tes d√©j√† connect√©</p>
                <p class="message">Redirection...</p>
              `;
              setTimeout(() => {
                window.location.href = "/chapitre1_installation/";
              }, 500);
            }
          }
        });

        // √âv√©nement : Signup
        netlifyIdentity.on("signup", (user) => {
          console.log("Signup:", user.email);
          authStatus.innerHTML = `
            <p class="message success">‚úÖ Compte cr√©√© !</p>
            <p class="message">Veuillez maintenant vous connecter</p>
          `;
          setTimeout(() => {
            netlifyIdentity.open('login');
          }, 1500);
        });

        // √âv√©nement : Login r√©ussi
        netlifyIdentity.on("login", (user) => {
          console.log("Login r√©ussi:", user.email);

          // Cr√©er la session
          localStorage.setItem(SESSION_KEY, Date.now().toString());
          
          // Fermer le modal
          netlifyIdentity.close();

          // Message de succ√®s
          authStatus.innerHTML = `
            <p class="message success">‚úÖ Connexion r√©ussie !</p>
            <p class="message">Bienvenue ${user.user_metadata.full_name || user.email}</p>
            <p class="message">Chargement du manuel...</p>
          `;

          // Redirection
          console.log("Redirection vers le manuel...");
          window.location.href = "/chapitre1_installation/";
        });

        // √âV√âNEMENT : Fermeture du modal
        netlifyIdentity.on("close", () => {
          const currentUser = netlifyIdentity.currentUser();
          console.log(
            "Modal ferm√© - Utilisateur:",
            currentUser ? currentUser.email : "aucun"
          );

          if (!currentUser) {
            authStatus.innerHTML = `
              <p class="message warning">‚ö†Ô∏è Vous devez vous connecter pour acc√©der au manuel</p>
              <button class="btn" onclick="netlifyIdentity.open()">Se connecter</button>
            `;
          }
        });

        // √âV√âNEMENT : Erreur
        netlifyIdentity.on("error", (err) => {
          console.error("Erreur Identity:", err);
          authStatus.innerHTML = `
            <p class="message error">‚ùå Erreur de connexion</p>
            <p class="message">${err.message || "Erreur inconnue"}</p>
            <button class="btn" onclick="netlifyIdentity.open()">R√©essayer</button>
          `;
        });

        // √âV√âNEMENT : Logout
        netlifyIdentity.on("logout", () => {
          console.log("D√©connexion effectu√©e");
          localStorage.removeItem(SESSION_KEY);
        });
      } else {
        console.error("Netlify Identity non charg√©");
        authStatus.innerHTML = `
          <p class="message error">‚ùå Erreur de chargement du syst√®me d'authentification</p>
          <p class="message">Veuillez rafra√Æchir la page</p>
          <button class="btn" onclick="location.reload()">Rafra√Æchir</button>
        `;
      }
    </script>
  </body>
</html>
